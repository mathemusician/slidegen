<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SlideGen - Generate slides from scripture</title>
  
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700;800;900&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --bg: #f5f3f2;
      --text: #0a0a0a;
      --muted: #4b4b4b;
      --card: #ffffff;
      --ring: rgba(10,10,10,0.1);
      --shadow: 0 1px 2px rgba(0,0,0,0.06), 0 8px 32px rgba(0,0,0,0.06);
      --container: 1200px;
      --radius: 20px;
      --pill: 9999px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      color: var(--text);
      background: var(--bg);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    h1, h2, h3, h4, h5, h6 {
      font-family: 'Playfair Display', Georgia, serif;
    }

    /* Layout */
    .shell {
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto 1fr;
    }

    .container {
      width: 100%;
      max-width: var(--container);
      margin-inline: auto;
      padding-inline: clamp(16px, 3vw, 32px);
    }

    /* Navigation */
    .nav {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: clamp(12px, 2vw, 24px);
      padding-block: clamp(16px, 2.5vw, 28px);
    }

    .brand {
      position: relative;
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 900;
      letter-spacing: 0.4px;
      font-size: clamp(24px, 2.6vw, 40px);
      line-height: 1;
      user-select: none;
      background-image: linear-gradient(90deg, #0a0a0a 0%, #0a0a0a 30%, rgba(0,0,0,.6) 45%, #0a0a0a 70%, #0a0a0a 100%);
      background-size: 200% 100%;
      background-position: 0 0;
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }

    @media (hover:hover) and (pointer:fine) {
      .brand:hover {
        animation: shimmer 1.2s ease forwards;
      }
    }

    @keyframes shimmer {
      from { background-position: -120% 0; }
      to { background-position: 120% 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      .brand, .brand:hover {
        animation: none;
        background-position: 0 0;
        color: #0a0a0a;
        -webkit-background-clip: initial;
        background-clip: initial;
      }
    }

    .nav-actions {
      display: flex;
      gap: clamp(8px, 1.2vw, 16px);
      align-items: center;
    }

    .btn {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: clamp(8px, 1.2vw, 10px) clamp(14px, 2vw, 18px);
      border-radius: var(--pill);
      border: 1px solid rgba(10,10,10,0.12);
      background: var(--card);
      text-decoration: none;
      color: var(--text);
      font-weight: 600;
      letter-spacing: 0.6px;
      font-size: clamp(11px, 1.4vw, 14px);
      text-transform: uppercase;
      box-shadow: var(--shadow);
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease, filter .12s ease;
      cursor: pointer;
      font-family: 'Inter', sans-serif;
      overflow: hidden;
    }
    
    @media (hover:hover) and (pointer:fine) {
      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.10), 0 12px 42px rgba(0,0,0,0.10);
        border-color: rgba(10,10,10,0.20);
      }
    }
    
    .btn:active {
      transform: scale(.97);
      filter: brightness(.97);
    }
    
    .btn:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }

    .btn.active {
      background: var(--text);
      color: var(--card);
      border-color: var(--text);
    }

    /* Ripple effect */
    .ripple {
      position: absolute;
      border-radius: 50%;
      pointer-events: none;
      background: rgba(0,0,0,.12);
      transform: scale(0);
      animation: ripple .6s ease-out forwards;
    }

    @keyframes ripple {
      to {
        transform: scale(1);
        opacity: 0;
      }
    }

    /* Hero */
    main {
      display: grid;
      place-items: center;
      min-height: calc(100dvh - 96px);
    }

    .hero {
      text-align: center;
      width: fit-content;
      max-width: min(1200px, 92vw);
      margin-inline: auto;
      padding-block: clamp(48px, 12vh, 140px);
      transition: transform .3s ease;
      will-change: transform;
    }

    .hero h1 {
      margin: 0 0 clamp(12px, 2vh, 18px) 0;
    }

    .hero-title {
      font-family: 'Playfair Display', Georgia, serif;
      font-weight: 900;
      font-size: clamp(64px, 12vw, 148px);
      line-height: 0.92;
      letter-spacing: 0.2px;
      font-feature-settings: "liga" 0;
      font-kerning: none;
      white-space: nowrap;
      display: inline-flex;
      align-items: baseline;
      gap: 2px;
      position: relative;
    }

    .hero-title .title-ghost {
      visibility: hidden;
      pointer-events: none;
      position: absolute;
      inset: 0;
    }

    .hero-title .title-text {
      display: inline-block;
    }

    .hero-title .title-text span {
      display: inline-block;
      transition: transform .35s cubic-bezier(0.34, 1.8, 0.64, 1);
      will-change: transform;
    }

    @media (hover:hover) and (pointer:fine) {
      #title:hover .title-text span {
        transform: translateY(-32px) scale(1.15);
      }
    }

    @media (prefers-reduced-motion: reduce) {
      #title:hover .title-text span {
        transform: none;
      }
    }

    .hero-title .caret {
      display: inline-block;
      width: 3px;
      height: 0.9em;
      background: rgba(0,0,0,.75);
      transform: translateY(2px);
      animation: blink .75s step-end infinite;
    }

    @keyframes blink {
      50% { opacity: 0; }
    }

    @media (prefers-reduced-motion: reduce) {
      .caret {
        animation: none;
        opacity: 1;
      }
    }

    .hero p {
      margin: 0;
      font-style: italic;
      color: var(--muted);
      font-size: clamp(18px, 2.2vw, 28px);
    }

    /* Cards */
    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
      gap: clamp(20px, 3vw, 32px);
      padding-block: clamp(32px, 5vh, 64px);
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(10,10,10,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: clamp(20px, 3vw, 32px);
    }

    .card h2 {
      font-size: clamp(24px, 3vw, 32px);
      font-weight: 700;
      margin-bottom: clamp(16px, 2vw, 24px);
    }

    /* Form elements */
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin-bottom: 8px;
    }

    input[type="text"],
    textarea {
      width: 100%;
      padding: clamp(12px, 1.5vw, 16px);
      border: 1px solid rgba(10,10,10,0.12);
      border-radius: 8px;
      font-size: clamp(14px, 1.6vw, 16px);
      font-family: 'Inter', sans-serif;
      background: var(--card);
      color: var(--text);
      transition: border-color 150ms ease;
    }

    input[type="text"]:focus,
    textarea:focus {
      outline: none;
      border-color: var(--text);
    }

    input[type="text"][aria-invalid="true"],
    textarea[aria-invalid="true"] {
      border-color: #dc2626;
    }

    textarea {
      resize: vertical;
      min-height: 120px;
      font-family: 'Inter', monospace;
    }

    .helper-text {
      font-size: 13px;
      color: var(--muted);
      margin-top: 6px;
    }

    /* Background selector */
    .background-selector {
      margin-bottom: clamp(16px, 2.5vw, 24px);
    }

    .preset-colors {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 12px;
    }

    .color-option {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 150ms ease;
      position: relative;
    }

    .color-option:hover {
      transform: scale(1.1);
      border-color: var(--text);
    }

    .color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
    }

    .color-option.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: white;
      font-size: 20px;
      font-weight: bold;
      text-shadow: 0 0 3px rgba(0,0,0,0.5);
    }

    .upload-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border: 2px dashed rgba(10,10,10,0.2);
      border-radius: 8px;
      background: var(--bg);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      transition: all 150ms ease;
    }

    .upload-btn:hover {
      border-color: var(--text);
      color: var(--text);
    }

    .upload-btn input {
      display: none;
    }

    .preview-image {
      margin-top: 12px;
      max-width: 200px;
      border-radius: 8px;
      border: 1px solid rgba(10,10,10,0.1);
    }

    .contrast-warning {
      margin-top: 8px;
      padding: 8px 12px;
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 6px;
      font-size: 12px;
      color: #856404;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Text color selector */
    .text-color-selector {
      margin-bottom: clamp(16px, 2.5vw, 24px);
    }

    .text-colors {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      margin-top: 12px;
    }

    .text-color-option {
      width: 50px;
      height: 50px;
      border-radius: 8px;
      border: 2px solid rgba(10,10,10,0.2);
      cursor: pointer;
      transition: all 150ms ease;
      position: relative;
    }

    .text-color-option:hover {
      transform: scale(1.1);
      border-color: var(--text);
    }

    .text-color-option.selected {
      border-color: var(--text);
      box-shadow: 0 0 0 3px rgba(10,10,10,0.1);
    }

    .text-color-option.selected::after {
      content: '✓';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 20px;
      font-weight: bold;
      text-shadow: 0 0 3px rgba(0,0,0,0.8), 0 0 6px rgba(255,255,255,0.8);
    }

    .custom-color-picker {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border: 2px solid rgba(10,10,10,0.2);
      border-radius: 8px;
      background: var(--card);
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      transition: all 150ms ease;
    }

    .custom-color-picker:hover {
      border-color: var(--text);
      color: var(--text);
    }

    .custom-color-picker input[type="color"] {
      width: 30px;
      height: 30px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Font selector */
    .font-selector {
      margin-bottom: clamp(16px, 2.5vw, 24px);
    }

    .font-select {
      width: 100%;
      padding: clamp(12px, 1.5vw, 14px) clamp(12px, 1.5vw, 16px);
      border: 1px solid rgba(10,10,10,0.12);
      border-radius: 8px;
      font-size: clamp(14px, 1.6vw, 16px);
      font-family: 'Inter', sans-serif;
      background: var(--card);
      color: var(--text);
      cursor: pointer;
      transition: border-color 150ms ease;
      margin-top: 12px;
    }

    .font-select:hover {
      border-color: rgba(10,10,10,0.24);
    }

    .font-select:focus {
      outline: none;
      border-color: var(--text);
    }

    .font-select option {
      padding: 8px;
    }

    /* Visual slide preview */
    .visual-preview {
      margin-top: 24px;
    }

    .slide-mockup {
      aspect-ratio: 16 / 9;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 10%;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .slide-mockup.has-image {
      background-size: cover;
      background-position: center;
    }

    .slide-mockup-bg {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }

    .slides-visual-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .slide-visual-card {
      border: 1px solid rgba(10,10,10,0.08);
      border-radius: 12px;
      overflow: hidden;
      background: var(--card);
      box-shadow: var(--shadow);
    }

    .slide-visual-label {
      padding: 8px 12px;
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.6px;
      background: var(--bg);
    }

    .slide-mockup-text {
      color: white;
      font-size: clamp(18px, 3vw, 32px);
      font-weight: bold;
      text-align: center;
      max-width: 100%;
      word-wrap: break-word;
      position: relative;
      z-index: 1;
    }

    .error-text {
      font-size: 13px;
      color: #dc2626;
      margin-top: 6px;
    }

    .form-group {
      margin-bottom: clamp(16px, 2.5vw, 24px);
    }

    .btn-primary {
      position: relative;
      width: 100%;
      padding: clamp(14px, 2vw, 18px) clamp(24px, 3vw, 32px);
      background: var(--text);
      color: var(--card);
      border: none;
      border-radius: var(--pill);
      font-weight: 600;
      font-size: clamp(14px, 1.6vw, 16px);
      text-transform: uppercase;
      letter-spacing: 0.8px;
      cursor: pointer;
      transition: transform .18s ease, box-shadow .18s ease, filter .12s ease;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    @media (hover:hover) and (pointer:fine) {
      .btn-primary:hover:not(:disabled) {
        transform: translateY(-3px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.10), 0 12px 42px rgba(0,0,0,0.10);
      }
    }

    .btn-primary:active:not(:disabled) {
      transform: scale(.97);
      filter: brightness(.97);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary:focus-visible {
      outline: 2px solid var(--ring);
      outline-offset: 2px;
    }

    @media (min-width: 600px) {
      .btn-primary {
        width: auto;
        min-width: 200px;
      }
    }

    /* Preview */
    .preview {
      margin-top: clamp(24px, 4vw, 48px);
      padding: clamp(20px, 3vw, 32px);
      background: var(--card);
      border: 1px solid rgba(10,10,10,0.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .preview-header {
      margin-bottom: 20px;
    }

    .preview h3 {
      font-size: clamp(18px, 2.2vw, 24px);
      font-weight: 700;
    }


    .slides-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
    }

    .slide-tile {
      padding: 16px;
      border: 1px solid rgba(10,10,10,0.08);
      border-radius: 12px;
      background: var(--bg);
      position: relative;
    }

    .slide-number {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
    }

    .slide-preview {
      font-size: 14px;
      line-height: 1.4;
      color: var(--text);
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .copy-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      padding: 6px;
      border: none;
      background: var(--card);
      border-radius: 6px;
      cursor: pointer;
      opacity: 0;
      transition: opacity 150ms ease;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .slide-tile:hover .copy-btn {
      opacity: 1;
    }

    .hidden {
      display: none;
    }

    /* Status banner */
    .status-banner {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .status-banner.error {
      background: #fee;
      color: #dc2626;
      border: 1px solid #fcc;
    }

    .status-banner.success {
      background: #efe;
      color: #059669;
      border: 1px solid #cfc;
    }

    /* Scroll reveal */
    .reveal {
      opacity: 0;
      transform: translateY(16px);
      transition: opacity .6s ease, transform .6s ease;
    }

    .reveal.in {
      opacity: 1;
      transform: translateY(0);
    }

    @media (prefers-reduced-motion: reduce) {
      .reveal {
        opacity: 1;
        transform: none;
        transition: none;
      }
    }

    /* Loading spinner */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-right: 8px;
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- NAVIGATION -->
    <header class="container nav" role="banner">
      <div class="brand">SlideGen</div>
      <nav class="nav-actions" aria-label="Primary">
        <button class="btn active" id="btn-lyrics" aria-pressed="true">Slide Generator</button>
        <button class="btn" id="btn-bible" aria-pressed="false">Bible</button>
      </nav>
    </header>

    <!-- HERO -->
    <main role="main">
      <section class="hero">
        <h1 id="title" class="hero-title" aria-live="polite" aria-atomic="true">
          <span class="title-ghost" aria-hidden="true">SlideGen</span>
          <span class="title-text"></span>
          <span class="caret" aria-hidden="true"></span>
        </h1>
        <p>Generate slides from lyrics or scripture</p>
      </section>
    </main>
  </div>

  <!-- CARDS SECTION -->
  <section class="container">
    <div class="cards reveal">
      <!-- Bible Card -->
      <article class="card" id="card-bible" style="display: none;">
        <h2>Create from Bible</h2>
        
        <div id="bible-status" role="status" aria-live="polite"></div>
        
        <form id="form-bible">
          <div class="form-group">
            <label for="input-passage">Passage</label>
            <input 
              type="text" 
              id="input-passage" 
              name="passage"
              placeholder="e.g., John 3:16, Psalm 23, Romans 8:28-39"
              aria-describedby="passage-helper"
              required
            />
            <p class="helper-text" id="passage-helper">
              Enter any Bible reference
            </p>
            <p class="error-text hidden" id="passage-error" role="alert"></p>
          </div>
          
          <div class="form-group background-selector">
            <label>Background</label>
            <div class="preset-colors" id="bible-preset-colors">
              <div class="color-option selected" data-color="000000" style="background: #000000;" title="Black"></div>
              <div class="color-option" data-color="FFFFFF" style="background: #FFFFFF;" title="White"></div>
              <div class="color-option" data-color="2C3E50" style="background: #2C3E50;" title="Dark Blue"></div>
              <div class="color-option" data-color="8B4513" style="background: #8B4513;" title="Brown"></div>
              <div class="color-option" data-color="1a472a" style="background: #1a472a;" title="Forest Green"></div>
              <label class="upload-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Image
                <input type="file" id="bible-bg-upload" accept="image/png,image/jpeg,image/jpg" />
              </label>
            </div>
            <img id="bible-preview-img" class="preview-image hidden" alt="Background preview" />
            <div id="bible-contrast-warning" class="contrast-warning hidden">
              ⚠️ Low contrast detected - text may be hard to read
            </div>
          </div>
          
          <div class="form-group text-color-selector">
            <label>Text Color</label>
            <div class="text-colors" id="bible-text-colors">
              <div class="text-color-option selected" data-color="FFFFFF" style="background: #FFFFFF;" title="White"></div>
              <div class="text-color-option" data-color="000000" style="background: #000000;" title="Black"></div>
              <div class="text-color-option" data-color="FFD700" style="background: #FFD700;" title="Gold"></div>
              <div class="text-color-option" data-color="87CEEB" style="background: #87CEEB;" title="Sky Blue"></div>
              <div class="text-color-option" data-color="90EE90" style="background: #90EE90;" title="Light Green"></div>
              <label class="custom-color-picker">
                <input type="color" id="bible-text-color-picker" value="#FFFFFF" />
                Custom
              </label>
            </div>
          </div>
          
          <div class="form-group font-selector">
            <label>Font</label>
            <select class="font-select" id="bible-font-select">
              <option value="Calibri" selected>Calibri (Modern)</option>
              <option value="Arial">Arial (Clean)</option>
              <option value="Helvetica">Helvetica (Classic)</option>
              <option value="Georgia">Georgia (Serif)</option>
              <option value="Verdana">Verdana (Bold)</option>
              <option value="Montserrat">Montserrat (Contemporary)</option>
              <option value="Open Sans">Open Sans (Readable)</option>
              <option value="Futura">Futura (Minimalist)</option>
            </select>
          </div>
          
          <button type="submit" class="btn-primary" id="btn-bible-submit">
            Generate Presentation
          </button>
        </form>
      </article>

      <!-- Lyrics Card -->
      <article class="card" id="card-lyrics">
        <h2>Insert Lyrics</h2>
        
        <div id="lyrics-status" role="status" aria-live="polite"></div>
        
        <form id="form-lyrics">
          <div class="form-group">
            <label for="input-title">Title (Optional)</label>
            <input 
              type="text"
              id="input-title" 
              name="title"
              placeholder="Enter presentation title"
            />
          </div>
          <div class="form-group">
            <label for="input-lyrics">Lyrics</label>
            <textarea 
              id="input-lyrics" 
              name="lyrics"
              placeholder="Paste your lyrics here..."
              aria-describedby="lyrics-helper"
              rows="10"
              required
            ></textarea>
            <p class="helper-text" id="lyrics-helper">
              Paste lyrics or a chorus
            </p>
            <p class="error-text hidden" id="lyrics-error" role="alert"></p>
          </div>
          
          <div class="form-group background-selector">
            <label>Background</label>
            <div class="preset-colors" id="lyrics-preset-colors">
              <div class="color-option selected" data-color="000000" style="background: #000000;" title="Black"></div>
              <div class="color-option" data-color="FFFFFF" style="background: #FFFFFF;" title="White"></div>
              <div class="color-option" data-color="2C3E50" style="background: #2C3E50;" title="Dark Blue"></div>
              <div class="color-option" data-color="8B4513" style="background: #8B4513;" title="Brown"></div>
              <div class="color-option" data-color="1a472a" style="background: #1a472a;" title="Forest Green"></div>
              <label class="upload-btn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                Upload Image
                <input type="file" id="lyrics-bg-upload" accept="image/png,image/jpeg,image/jpg" />
              </label>
            </div>
            <img id="lyrics-preview-img" class="preview-image hidden" alt="Background preview" />
            <div id="lyrics-contrast-warning" class="contrast-warning hidden">
              ⚠️ Low contrast detected - text may be hard to read
            </div>
          </div>
          
          <div class="form-group text-color-selector">
            <label>Text Color</label>
            <div class="text-colors" id="lyrics-text-colors">
              <div class="text-color-option selected" data-color="FFFFFF" style="background: #FFFFFF;" title="White"></div>
              <div class="text-color-option" data-color="000000" style="background: #000000;" title="Black"></div>
              <div class="text-color-option" data-color="FFD700" style="background: #FFD700;" title="Gold"></div>
              <div class="text-color-option" data-color="87CEEB" style="background: #87CEEB;" title="Sky Blue"></div>
              <div class="text-color-option" data-color="90EE90" style="background: #90EE90;" title="Light Green"></div>
              <label class="custom-color-picker">
                <input type="color" id="lyrics-text-color-picker" value="#FFFFFF" />
                Custom
              </label>
            </div>
          </div>
          
          <div class="form-group font-selector">
            <label>Font</label>
            <select class="font-select" id="lyrics-font-select">
              <option value="Calibri" selected>Calibri (Modern)</option>
              <option value="Arial">Arial (Clean)</option>
              <option value="Helvetica">Helvetica (Classic)</option>
              <option value="Georgia">Georgia (Serif)</option>
              <option value="Verdana">Verdana (Bold)</option>
              <option value="Montserrat">Montserrat (Contemporary)</option>
              <option value="Open Sans">Open Sans (Readable)</option>
              <option value="Futura">Futura (Minimalist)</option>
            </select>
          </div>
          
          <button type="submit" class="btn-primary" id="btn-lyrics-submit">
            Generate Presentation
          </button>
        </form>
      </article>
    </div>

    <!-- Preview Section -->
    <div id="preview-section" class="preview hidden">
      <div class="preview-header">
        <h3>Preview</h3>
      </div>
      
      <!-- Visual Preview -->
      <div class="visual-preview">
        <h4 style="font-size: 14px; font-weight: 600; color: var(--muted); margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.6px;">Slide Previews</h4>
        <div class="slides-visual-grid" id="visual-slides-grid"></div>
      </div>
      
      <div class="slides-grid" id="slides-container" style="margin-top: 32px;"></div>
    </div>
  </section>

  <script>
    // ============================================================================
    // STATE MANAGEMENT
    // ============================================================================
    window.appState = {
      slides: [],
      sourceType: 'lyrics',
      loading: false,
      error: null,
      background: { type: 'color', value: '000000' }, // Default black background
      textColor: 'FFFFFF', // Default white text
      fontFamily: 'Calibri' // Default modern font
    };

    // ============================================================================
    // DOM UTILITIES
    // ============================================================================
    const qs = (sel) => document.querySelector(sel);
    const qsa = (sel) => document.querySelectorAll(sel);

    async function copyToClipboard(text) {
      try {
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(text);
        } else {
          // Fallback for older browsers
          const textarea = document.createElement('textarea');
          textarea.value = text;
          textarea.style.position = 'fixed';
          textarea.style.opacity = '0';
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }
        return true;
      } catch (err) {
        console.error('Copy failed:', err);
        return false;
      }
    }

    // ============================================================================
    // PREVIEW GENERATION
    // ============================================================================
    function generatePreviewSlides(lyrics) {
      // Split by empty lines to respect original grouping
      const groups = lyrics.split(/\n\s*\n/);
      const slidesContent = [];
      
      for (const group of groups) {
        let lines = group.split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0);
        
        // Filter out common header patterns for preview
        lines = lines.filter(line => {
          if (line.startsWith('[') && line.endsWith(']')) return false;
          if (/^(verse|chorus|bridge|intro|outro)\s*\d*$/i.test(line)) return false;
          return true;
        });
        
        // Smart grouping within each group
        let i = 0;
        while (i < lines.length) {
          const remaining = lines.length - i;
          
          if (remaining === 1) {
            slidesContent.push(lines[i]);
            i += 1;
          } else if (remaining === 2) {
            slidesContent.push(lines.slice(i, i + 2).join('\n'));
            i += 2;
          } else if (remaining === 3) {
            slidesContent.push(lines.slice(i, i + 2).join('\n'));
            slidesContent.push(lines[i + 2]);
            i += 3;
          } else if (remaining >= 4) {
            slidesContent.push(lines.slice(i, i + 2).join('\n'));
            i += 2;
          }
        }
      }
      
      setState({ slides: slidesContent });
    }

    // ============================================================================
    // BACKGROUND HANDLING
    // ============================================================================
    function updateVisualPreview() {
      const { background, slides } = window.appState;
      const visualGrid = qs('#visual-slides-grid');
      
      if (!visualGrid) return;
      
      // Clear existing previews
      visualGrid.innerHTML = '';
      
      // Show up to 3 slides in visual preview
      const slidesToShow = Math.min(slides.length || 1, 3);
      const previewSlides = slides.length > 0 ? slides : ['Your text will appear here'];
      
      for (let i = 0; i < slidesToShow; i++) {
        const slideContent = previewSlides[i] || 'Slide content';
        const displayText = slideContent.split('\n').slice(0, 3).join('\n');
        
        const card = document.createElement('div');
        card.className = 'slide-visual-card';
        
        const label = document.createElement('div');
        label.className = 'slide-visual-label';
        label.textContent = slides.length > 0 ? `Slide ${i + 1}` : 'Preview';
        
        const mockup = document.createElement('div');
        mockup.className = 'slide-mockup';
        
        // Add background
        if (background.type === 'color') {
          mockup.style.backgroundColor = '#' + background.value;
        } else if (background.type === 'image') {
          const bgImg = document.createElement('img');
          bgImg.className = 'slide-mockup-bg';
          bgImg.src = background.value;
          bgImg.alt = '';
          mockup.appendChild(bgImg);
        }
        
        // Add text with selected color and font
        const text = document.createElement('div');
        text.className = 'slide-mockup-text';
        text.textContent = displayText;
        text.style.color = '#' + window.appState.textColor;
        
        // Apply font with proper fallbacks
        const fontFamily = window.appState.fontFamily;
        const fontMap = {
          'Calibri': 'Calibri, Arial, sans-serif',
          'Arial': 'Arial, Helvetica, sans-serif',
          'Helvetica': 'Helvetica, Arial, sans-serif',
          'Georgia': 'Georgia, "Times New Roman", serif',
          'Verdana': 'Verdana, Geneva, sans-serif',
          'Montserrat': '"Montserrat", Arial, sans-serif',
          'Open Sans': '"Open Sans", Arial, sans-serif',
          'Futura': 'Futura, "Trebuchet MS", Arial, sans-serif'
        };
        text.style.fontFamily = fontMap[fontFamily] || fontFamily;
        
        mockup.appendChild(text);
        
        card.appendChild(label);
        card.appendChild(mockup);
        visualGrid.appendChild(card);
      }
    }

    function checkContrast(imageData, warningElementId) {
      // Simple contrast check - analyze average brightness
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();
      
      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        
        const imageDataObj = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageDataObj.data;
        let totalBrightness = 0;
        
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          // Calculate perceived brightness
          const brightness = (r * 299 + g * 587 + b * 114) / 1000;
          totalBrightness += brightness;
        }
        
        const avgBrightness = totalBrightness / (data.length / 4);
        const warningEl = qs('#' + warningElementId);
        
        // Show warning if background is too bright (white text may not be readable)
        if (avgBrightness > 180) {
          warningEl?.classList.remove('hidden');
        } else {
          warningEl?.classList.add('hidden');
        }
      };
      
      img.src = imageData;
    }

    function handleColorSelection(container, color) {
      // Update selected state
      container.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      // Update app state
      setState({ background: { type: 'color', value: color } });
      updateVisualPreview();
      checkTextBackgroundContrast();
      
      // Hide image preview
      const cardId = container.id.split('-')[0];
      const imgPreview = qs(`#${cardId}-preview-img`);
      const contrastWarning = qs(`#${cardId}-contrast-warning`);
      imgPreview?.classList.add('hidden');
      contrastWarning?.classList.add('hidden');
    }

    function handleTextColorSelection(container, color) {
      // Update selected state
      container.querySelectorAll('.text-color-option').forEach(opt => {
        opt.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      // Update app state
      setState({ textColor: color });
      updateVisualPreview();
      checkTextBackgroundContrast();
    }

    function handleCustomTextColor(inputElement) {
      const hexColor = inputElement.value.replace('#', '');
      setState({ textColor: hexColor });
      updateVisualPreview();
      checkTextBackgroundContrast();
      
      // Deselect preset options
      const container = inputElement.closest('.text-colors');
      container?.querySelectorAll('.text-color-option').forEach(opt => {
        opt.classList.remove('selected');
      });
    }

    function checkTextBackgroundContrast() {
      const { background, textColor } = window.appState;
      
      // Only check for solid color backgrounds
      if (background.type !== 'color') return;
      
      // Calculate relative luminance
      const getLuminance = (hex) => {
        const rgb = parseInt(hex, 16);
        const r = ((rgb >> 16) & 0xff) / 255;
        const g = ((rgb >> 8) & 0xff) / 255;
        const b = (rgb & 0xff) / 255;
        
        const [rs, gs, bs] = [r, g, b].map(c => 
          c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4)
        );
        
        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
      };
      
      const bgLuminance = getLuminance(background.value);
      const textLuminance = getLuminance(textColor);
      
      // Calculate contrast ratio
      const contrast = (Math.max(bgLuminance, textLuminance) + 0.05) / 
                      (Math.min(bgLuminance, textLuminance) + 0.05);
      
      // WCAG AA requires 4.5:1 for normal text, 3:1 for large text
      // We use 3.5:1 as threshold for large presentation text
      const warnings = qsa('.contrast-warning');
      if (contrast < 3.5) {
        warnings.forEach(w => w.classList.remove('hidden'));
      } else {
        warnings.forEach(w => w.classList.add('hidden'));
      }
    }

    async function cropImageTo16x9(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Target 16:9 aspect ratio
            const targetRatio = 16 / 9;
            const imgRatio = img.width / img.height;
            
            let sourceX = 0, sourceY = 0, sourceW = img.width, sourceH = img.height;
            
            if (imgRatio > targetRatio) {
              // Image is wider - crop width
              sourceW = img.height * targetRatio;
              sourceX = (img.width - sourceW) / 2;
            } else if (imgRatio < targetRatio) {
              // Image is taller - crop height
              sourceH = img.width / targetRatio;
              sourceY = (img.height - sourceH) / 2;
            }
            
            // Set canvas to 16:9 with reasonable resolution
            canvas.width = 1920;
            canvas.height = 1080;
            
            // Draw cropped image
            ctx.drawImage(img, sourceX, sourceY, sourceW, sourceH, 0, 0, canvas.width, canvas.height);
            
            // Convert to base64
            const croppedBase64 = canvas.toDataURL('image/jpeg', 0.9);
            resolve(croppedBase64);
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    }

    async function handleImageUpload(fileInput, cardId) {
      const file = fileInput.files[0];
      if (!file) return;
      
      // Validate file type
      if (!file.type.match(/image\/(png|jpeg|jpg)/)) {
        alert('Please upload a PNG or JPEG image');
        return;
      }
      
      // Validate file size (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        alert('Image must be smaller than 5MB');
        return;
      }
      
      // Crop image to 16:9 aspect ratio
      const croppedBase64 = await cropImageTo16x9(file);
      
      // Update app state
      setState({ background: { type: 'image', value: croppedBase64 } });
      updateVisualPreview();
      
      // Show preview
      const imgPreview = qs(`#${cardId}-preview-img`);
      imgPreview.src = croppedBase64;
      imgPreview.classList.remove('hidden');
      
      // Check contrast for images
      checkContrast(croppedBase64, `${cardId}-contrast-warning`);
      
      // Deselect color options
      qs(`#${cardId}-preset-colors`)?.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.remove('selected');
      });
    }

    // ============================================================================
    // API LAYER - Integrated with Next.js backend
    // ============================================================================
    async function fetchBible(reference) {
      // Fetch from ESV API via Next.js route
      const esvResponse = await fetch(`/api/esv?passage=${encodeURIComponent(reference)}`);
      const esvData = await esvResponse.json();

      if (!esvData.success) {
        throw new Error('Failed to fetch passage from ESV API');
      }

      // Generate PowerPoint via Next.js route
      const response = await fetch('/api/generate-bible-ppt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          verses: esvData.passages[0], 
          title: esvData.reference,
          background: window.appState.background,
          textColor: window.appState.textColor,
          fontFamily: window.appState.fontFamily
        }),
      });

      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to generate presentation');
      }

      // Return download URL
      return {
        downloadUrl: data.downloadUrl,
        reference: esvData.reference
      };
    }

    async function processLyrics(text, title = 'Lyrics') {
      // Generate PowerPoint via Next.js route with existing logic
      const response = await fetch('/api/generate-ppt', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          lyrics: text, 
          title: title || 'Lyrics Presentation',
          background: window.appState.background,
          textColor: window.appState.textColor,
          fontFamily: window.appState.fontFamily
        }),
      });

      const data = await response.json();
      
      if (!data.success) {
        throw new Error(data.error || 'Failed to generate presentation');
      }

      // Return download URL
      return {
        downloadUrl: data.downloadUrl,
        title: title
      };
    }

    // ============================================================================
    // STATE AND RENDERING
    // ============================================================================
    function setState(patch) {
      Object.assign(window.appState, patch);
      renderPreview();
      updateVisualPreview();
      saveToLocalStorage();
    }

    function renderPreview() {
      const { slides } = window.appState;
      const previewSection = qs('#preview-section');
      const slidesContainer = qs('#slides-container');
      
      if (slides.length === 0) {
        previewSection.classList.add('hidden');
        return;
      }
      
      previewSection.classList.remove('hidden');
      slidesContainer.innerHTML = '';
      
      slides.forEach((content, index) => {
        const tile = document.createElement('div');
        tile.className = 'slide-tile';
        
        const firstWords = content.split(/\s+/).slice(0, 10).join(' ');
        const preview = firstWords + (content.split(/\s+/).length > 10 ? '...' : '');
        
        tile.innerHTML = `
          <div class="slide-number">Slide ${index + 1}</div>
          <div class="slide-preview">${preview}</div>
          <button class="copy-btn" aria-label="Copy slide ${index + 1}" data-index="${index}">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
          </button>
        `;
        
        slidesContainer.appendChild(tile);
      });
      
      // Attach copy handlers
      qsa('.copy-btn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const index = parseInt(e.currentTarget.dataset.index);
          const success = await copyToClipboard(slides[index]);
          if (success) {
            e.currentTarget.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="20 6 9 17 4 12"></polyline>
              </svg>
            `;
            setTimeout(() => {
              e.currentTarget.innerHTML = `
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                  <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                </svg>
              `;
            }, 1500);
          }
        });
      });
    }

    function renderStatus(cardId, message, type = 'error') {
      const statusEl = qs(`#${cardId}-status`);
      if (!message) {
        statusEl.innerHTML = '';
        return;
      }
      
      statusEl.innerHTML = `<div class="status-banner ${type}">${message}</div>`;
    }

    function renderDownload(cardId, downloadUrl, filename) {
      const card = qs(`#card-${cardId}`);
      let downloadSection = card.querySelector('.download-section');
      
      if (!downloadSection) {
        downloadSection = document.createElement('div');
        downloadSection.className = 'download-section';
        downloadSection.style.cssText = 'margin-top: 24px; padding: 20px; background: var(--bg); border-radius: 16px; text-align: center;';
        card.appendChild(downloadSection);
      }
      
      downloadSection.innerHTML = `
        <p style="font-size: 13px; font-weight: 600; color: var(--muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.8px;">Your presentation is ready</p>
        <a href="${downloadUrl}" download="${filename}.pptx" class="btn-primary" style="display: inline-block; text-decoration: none;">Download PowerPoint</a>
      `;
    }

    // ============================================================================
    // LOCAL STORAGE
    // ============================================================================
    function saveToLocalStorage() {
      try {
        localStorage.setItem('slidegen-state', JSON.stringify({
          slides: window.appState.slides,
          sourceType: window.appState.sourceType,
          background: window.appState.background,
          textColor: window.appState.textColor,
          fontFamily: window.appState.fontFamily
        }));
      } catch (err) {
        console.error('Failed to save to localStorage:', err);
      }
    }

    function loadFromLocalStorage() {
      try {
        const saved = localStorage.getItem('slidegen-state');
        if (saved) {
          const data = JSON.parse(saved);
          setState(data);
        }
      } catch (err) {
        console.error('Failed to load from localStorage:', err);
      }
    }

    // ============================================================================
    // EVENT HANDLERS
    // ============================================================================
    async function onBibleSubmit(e) {
      e.preventDefault();
      
      const input = qs('#input-passage');
      const errorEl = qs('#passage-error');
      const submitBtn = qs('#btn-bible-submit');
      
      // Validate
      if (!input.value.trim()) {
        input.setAttribute('aria-invalid', 'true');
        errorEl.textContent = 'Please enter a Bible reference';
        errorEl.classList.remove('hidden');
        return;
      }
      
      // Clear errors
      input.removeAttribute('aria-invalid');
      errorEl.classList.add('hidden');
      renderStatus('bible', null);
      
      // Set loading state
      setState({ loading: true, error: null, downloadUrl: null });
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span>Generating…';
      
      try {
        const result = await fetchBible(input.value.trim());
        setState({ 
          downloadUrl: result.downloadUrl,
          reference: result.reference,
          sourceType: 'bible',
          loading: false 
        });
        renderDownload('bible', result.downloadUrl, result.reference);
        renderStatus('bible', 'Presentation generated successfully!', 'success');
        setTimeout(() => renderStatus('bible', null), 3000);
      } catch (err) {
        setState({ loading: false, error: err.message });
        renderStatus('bible', err.message || 'Failed to generate presentation');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Presentation';
      }
    }

    async function onLyricsSubmit(e) {
      e.preventDefault();
      
      const input = qs('#input-lyrics');
      const titleInput = qs('#input-title');
      const errorEl = qs('#lyrics-error');
      const submitBtn = qs('#btn-lyrics-submit');
      
      // Validate
      if (!input.value.trim()) {
        input.setAttribute('aria-invalid', 'true');
        errorEl.textContent = 'Please enter some lyrics';
        errorEl.classList.remove('hidden');
        return;
      }
      
      // Clear errors
      input.removeAttribute('aria-invalid');
      errorEl.classList.add('hidden');
      renderStatus('lyrics', null);
      
      // Set loading state
      setState({ loading: true, error: null, downloadUrl: null });
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner"></span>Generating…';
      
      try {
        const result = await processLyrics(input.value.trim(), titleInput.value.trim());
        setState({ 
          downloadUrl: result.downloadUrl,
          title: result.title,
          sourceType: 'lyrics',
          loading: false 
        });
        renderDownload('lyrics', result.downloadUrl, result.title || 'Lyrics');
        renderStatus('lyrics', 'Presentation generated successfully!', 'success');
        setTimeout(() => renderStatus('lyrics', null), 3000);
      } catch (err) {
        setState({ loading: false, error: err.message });
        renderStatus('lyrics', err.message || 'Failed to generate presentation');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Generate Presentation';
      }
    }

    // Clear and Export functions removed - user can simply delete text or refresh page

    function switchTab(tab) {
      // Update buttons
      const btnLyrics = qs('#btn-lyrics');
      const btnBible = qs('#btn-bible');
      const cardLyrics = qs('#card-lyrics');
      const cardBible = qs('#card-bible');
      
      if (tab === 'lyrics') {
        btnLyrics.classList.add('active');
        btnLyrics.setAttribute('aria-pressed', 'true');
        btnBible.classList.remove('active');
        btnBible.setAttribute('aria-pressed', 'false');
        cardLyrics.style.display = 'block';
        cardBible.style.display = 'none';
      } else {
        btnBible.classList.add('active');
        btnBible.setAttribute('aria-pressed', 'true');
        btnLyrics.classList.remove('active');
        btnLyrics.setAttribute('aria-pressed', 'false');
        cardBible.style.display = 'block';
        cardLyrics.style.display = 'none';
      }
    }

    // ============================================================================
    // TYPEWRITER EFFECT
    // ============================================================================
    async function typeText(el, text, msPerChar = 150) {
      el.innerHTML = '';
      for (let i = 0; i < text.length; i++) {
        const span = document.createElement('span');
        span.textContent = text[i];
        span.style.display = 'inline-block';
        span.style.transition = 'transform .18s ease';
        span.style.willChange = 'transform';
        span.style.transitionDelay = (i * 12) + 'ms';
        el.appendChild(span);
        await sleep(msPerChar);
      }
    }

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    // Remove any stray template placeholders
    function cleanStrayText() {
      const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
      const junk = [];
      while (walker.nextNode()) {
        const t = walker.currentNode;
        if (t.nodeValue && (t.nodeValue.trim().match(/^\{+\.{3}\}+$/) || (t.nodeValue.includes('{{') && t.nodeValue.includes('}}'))))  {
          junk.push(t);
        }
      }
      junk.forEach(n => n.parentNode && n.parentNode.removeChild(n));
    }

    // ============================================================================
    // MICRO-INTERACTIONS
    // ============================================================================
    function attachRipples() {
      document.querySelectorAll('.btn, .btn-primary').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const rect = btn.getBoundingClientRect();
          const r = Math.max(rect.width, rect.height);
          const x = (e.clientX || (e.touches && e.touches[0]?.clientX) || rect.left + rect.width/2) - rect.left;
          const y = (e.clientY || (e.touches && e.touches[0]?.clientY) || rect.top + rect.height/2) - rect.top;
          const span = document.createElement('span');
          span.className = 'ripple';
          span.style.width = span.style.height = r + 'px';
          span.style.left = (x - r/2) + 'px';
          span.style.top = (y - r/2) + 'px';
          btn.appendChild(span);
          span.addEventListener('animationend', () => span.remove());
        }, { passive: true });
      });
    }

    function revealOnScroll() {
      const io = new IntersectionObserver(entries => {
        entries.forEach(en => {
          if (en.isIntersecting) {
            en.target.classList.add('in');
            io.unobserve(en.target);
          }
        });
      }, { threshold: .12 });
      document.querySelectorAll('.reveal').forEach(el => io.observe(el));
    }

    function heroParallax() {
      const hero = document.querySelector('.hero');
      if (!hero) return;
      
      let raf, cx = 0, cy = 0;
      
      function onMove(e) {
        const rect = hero.getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width - .5;
        const y = (e.clientY - rect.top) / rect.height - .5;
        cx = x * 6;
        cy = y * 6;
        
        if (!raf) {
          raf = requestAnimationFrame(() => {
            hero.style.transform = `translate3d(${cx}px, ${cy}px, 0)`;
            raf = null;
          });
        }
      }
      
      if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      if (window.matchMedia('(pointer:fine)').matches) {
        hero.addEventListener('mousemove', onMove);
      }
    }

    // ============================================================================
    // INITIALIZATION
    // ============================================================================
    document.addEventListener('DOMContentLoaded', () => {
      // Clean any stray template text
      cleanStrayText();
      
      // Setup ghost text for layout reservation
      const ghostEl = document.querySelector('.title-ghost');
      const textEl = document.querySelector('.title-text');
      const full = 'SlideGen';
      
      if (ghostEl) ghostEl.textContent = full;
      
      // Trigger typewriter animation
      if (textEl) {
        typeText(textEl, full, 150);
      }
      
      // Initialize micro-interactions
      attachRipples();
      revealOnScroll();
      heroParallax();
      
      // Load saved state
      loadFromLocalStorage();
      
      // Attach event listeners
      qs('#form-bible').addEventListener('submit', onBibleSubmit);
      qs('#form-lyrics').addEventListener('submit', onLyricsSubmit);
      
      qs('#btn-lyrics').addEventListener('click', () => switchTab('lyrics'));
      qs('#btn-bible').addEventListener('click', () => switchTab('bible'));
      
      // Add real-time preview when user types lyrics
      qs('#input-lyrics')?.addEventListener('input', (e) => {
        const lyrics = e.target.value.trim();
        if (lyrics) {
          generatePreviewSlides(lyrics);
        } else {
          setState({ slides: [] });
        }
      });
      
      qs('#input-passage')?.addEventListener('input', (e) => {
        const passage = e.target.value.trim();
        if (passage) {
          // Simple preview for bible - just show the passage reference
          setState({ slides: [passage] });
        } else {
          setState({ slides: [] });
        }
      });
      
      // Background selectors - Bible
      qsa('#bible-preset-colors .color-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          const color = e.target.dataset.color;
          handleColorSelection(qs('#bible-preset-colors'), color);
        });
      });
      
      qs('#bible-bg-upload')?.addEventListener('change', (e) => {
        handleImageUpload(e.target, 'bible');
      });
      
      // Background selectors - Lyrics
      qsa('#lyrics-preset-colors .color-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          const color = e.target.dataset.color;
          handleColorSelection(qs('#lyrics-preset-colors'), color);
        });
      });
      
      qs('#lyrics-bg-upload')?.addEventListener('change', (e) => {
        handleImageUpload(e.target, 'lyrics');
      });
      
      // Text color selectors - Bible
      qsa('#bible-text-colors .text-color-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          const color = e.target.dataset.color;
          handleTextColorSelection(qs('#bible-text-colors'), color);
        });
      });
      
      qs('#bible-text-color-picker')?.addEventListener('input', (e) => {
        handleCustomTextColor(e.target);
      });
      
      // Text color selectors - Lyrics
      qsa('#lyrics-text-colors .text-color-option').forEach(opt => {
        opt.addEventListener('click', (e) => {
          const color = e.target.dataset.color;
          handleTextColorSelection(qs('#lyrics-text-colors'), color);
        });
      });
      
      qs('#lyrics-text-color-picker')?.addEventListener('input', (e) => {
        handleCustomTextColor(e.target);
      });
      
      // Font selectors - Bible and Lyrics
      qs('#bible-font-select')?.addEventListener('change', (e) => {
        setState({ fontFamily: e.target.value });
        updateVisualPreview();
      });
      
      qs('#lyrics-font-select')?.addEventListener('change', (e) => {
        setState({ fontFamily: e.target.value });
        updateVisualPreview();
      });
      
      // Initial render
      renderPreview();
      updateVisualPreview();
      checkTextBackgroundContrast();
      
      // Generate preview if lyrics already exist (e.g., from localStorage or user input)
      const existingLyrics = qs('#input-lyrics')?.value?.trim();
      if (existingLyrics) {
        generatePreviewSlides(existingLyrics);
      }
    });
  </script>
</body>
</html>
